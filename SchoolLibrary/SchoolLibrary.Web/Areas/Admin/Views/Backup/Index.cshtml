@{
    ViewData["Title"] = "Sao l∆∞u & Ph·ª•c h·ªìi";
}

<div class="content-box">
    <h2 class="mb-4">üíæ Sao l∆∞u & Ph·ª•c h·ªìi D·ªØ li·ªáu</h2>

    <div class="alert alert-warning">
        <strong>‚ö†Ô∏è C·∫£nh b√°o:</strong> Ch·ª©c nƒÉng ph·ª•c h·ªìi s·∫Ω x√≥a to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i v√† thay th·∫ø b·∫±ng d·ªØ li·ªáu t·ª´ file backup. Vui l√≤ng sao l∆∞u tr∆∞·ªõc khi ph·ª•c h·ªìi!
    </div>

    <div class="row">
        <!-- Create Backup -->
        <div class="col-md-6 mb-4">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üì• T·∫°o Sao l∆∞u</h5>
                </div>
                <div class="card-body">
                    <p>T·∫°o file sao l∆∞u to√†n b·ªô d·ªØ li·ªáu h·ªá th·ªëng d∆∞·ªõi d·∫°ng JSON.</p>
                    <form id="createBackupForm">
                        <button type="submit" class="btn btn-success btn-lg w-100">
                            üíæ T·∫°o Sao l∆∞u Ngay
                        </button>
                    </form>
                    <div id="backupResult" class="mt-3"></div>
                </div>
            </div>
        </div>

        <!-- Restore Backup -->
        <div class="col-md-6 mb-4">
            <div class="card border-warning">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">üì§ Ph·ª•c h·ªìi D·ªØ li·ªáu</h5>
                </div>
                <div class="card-body">
                    <p>Ph·ª•c h·ªìi d·ªØ li·ªáu t·ª´ file backup ƒë√£ t·∫°o tr∆∞·ªõc ƒë√≥.</p>
                    <div id="backupFiles">
                        <p class="text-muted">ƒêang t·∫£i danh s√°ch...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- List Backups -->
    <div class="card mt-4">
        <div class="card-header">
            <h5>üìã Danh s√°ch File Sao l∆∞u</h5>
        </div>
        <div class="card-body">
            <div id="backupList" class="table-responsive">
                <p class="text-center text-muted">ƒêang t·∫£i...</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Load backup files on page load
        $(document).ready(function() {
            loadBackupFiles();
        });

        // Create backup
        $('#createBackupForm').on('submit', function(e) {
            e.preventDefault();
            
            $.ajax({
                url: '@Url.Action("CreateBackup", "Backup")',
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        $('#backupResult').html('<div class="alert alert-success">' + response.message + '</div>');
                        loadBackupFiles();
                    } else {
                        $('#backupResult').html('<div class="alert alert-danger">' + response.message + '</div>');
                    }
                },
                error: function() {
                    $('#backupResult').html('<div class="alert alert-danger">L·ªói khi t·∫°o sao l∆∞u!</div>');
                }
            });
        });

        // Load backup files
        function loadBackupFiles() {
            $.get('@Url.Action("ListBackups", "Backup")', function(data) {
                var html = '';
                
                if (data.length === 0) {
                    html = '<p class="text-muted text-center">Ch∆∞a c√≥ file sao l∆∞u n√†o.</p>';
                } else {
                    html = '<table class="table table-striped"><thead><tr><th>T√™n file</th><th>K√≠ch th∆∞·ªõc</th><th>Ng√†y t·∫°o</th><th>Thao t√°c</th></tr></thead><tbody>';
                    
                    data.forEach(function(file) {
                        var sizeKB = (file.size / 1024).toFixed(2);
                        var date = new Date(file.createdDate).toLocaleString('vi-VN');
                        
                        html += '<tr><td>' + file.fileName + '</td>';
                        html += '<td>' + sizeKB + ' KB</td>';
                        html += '<td>' + date + '</td>';
                        html += '<td>';
                        html += '<button class="btn btn-sm btn-primary" onclick="downloadBackup(\'' + file.fileName + '\')">üì• T·∫£i</button> ';
                        html += '<button class="btn btn-sm btn-danger" onclick="restoreBackup(\'' + file.fileName + '\')">‚ö†Ô∏è Ph·ª•c h·ªìi</button>';
                        html += '</td></tr>';
                    });
                    
                    html += '</tbody></table>';
                }
                
                $('#backupList').html(html);
            });
        }

        // Download backup
        function downloadBackup(fileName) {
            window.location.href = '@Url.Action("DownloadBackup", "Backup")?fileName=' + fileName;
        }

        // Restore backup
        function restoreBackup(fileName) {
            if (!confirm('‚ö†Ô∏è C·∫¢NH B√ÅO: B·∫°n c√≥ ch·∫Øc mu·ªën ph·ª•c h·ªìi d·ªØ li·ªáu t·ª´ file "' + fileName + '"?\n\nTo√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i s·∫Ω b·ªã x√≥a!')) {
                return;
            }

            $.ajax({
                url: '@Url.Action("RestoreBackup", "Backup")',
                type: 'POST',
                data: { fileName: fileName },
                success: function(response) {
                    if (response.success) {
                        alert('Ph·ª•c h·ªìi th√†nh c√¥ng! Trang s·∫Ω ƒë∆∞·ª£c t·∫£i l·∫°i.');
                        location.reload();
                    } else {
                        alert('L·ªói: ' + response.message);
                    }
                },
                error: function() {
                    alert('L·ªói khi ph·ª•c h·ªìi!');
                }
            });
        }
    </script>
}

